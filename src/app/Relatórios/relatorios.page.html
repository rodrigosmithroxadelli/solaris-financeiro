<ion-content [fullscreen]="true" class="caixa-content">
  <div class="caixa-form relatorios-form">
    <div class="form-header">
      <div class="header-icon header-icon--reports">
        <ion-icon name="bar-chart"></ion-icon>
      </div>
      <div class="header-text">
        <h2>Relatórios</h2>
        <p>Análise rápida do desempenho financeiro</p>
      </div>
    </div>

    <div class="report-grid report-grid--two">
      <div class="report-card">
        <div class="section-header">
          <h3>Filtros</h3>
          <p>Defina o período e a data base</p>
        </div>
        <div class="form-group">
          <div class="form-label">Período</div>
          <ion-item class="form-item" lines="none">
            <ion-select [(ngModel)]="periodType" (ionChange)="onPeriodChange()" interface="popover" placeholder="Selecione">
              <ion-select-option value="dia">Diário</ion-select-option>
              <ion-select-option value="semana">Semanal</ion-select-option>
              <ion-select-option value="mes">Mensal</ion-select-option>
            </ion-select>
          </ion-item>
        </div>
    
        <div class="form-group">
          <div class="form-label">Data base</div>
          <div class="datetime-button">
            <ion-datetime
              id="report-datetime"
              [(ngModel)]="selectedDate"
              (ionChange)="onDateChange($event)"
              [presentation]="periodType === 'mes' ? 'month-year' : 'date'"
            ></ion-datetime>
          </div>
        </div>
    
        <div class="filter-feedback">
          <ion-icon name="calendar"></ion-icon>
          <span>
            Período
            {{
              periodType === 'dia'
                ? 'diário'
                : periodType === 'semana'
                  ? 'semanal'
                  : 'mensal'
            }}
            • Base {{ selectedDate | date: periodType === 'mes' ? 'MM/yyyy' : 'dd/MM/yyyy' }}
          </span>
        </div>
      </div>
  
      <div class="report-card">
        <div class="section-header">
          <h3>Exportação</h3>
          <p>Gere relatórios no formato desejado</p>
        </div>
        <div class="optional-actions">
          <ion-button class="action-btn" color="danger" (click)="exportPDF()">
            <ion-icon name="download" slot="start"></ion-icon>
            Exportar PDF
          </ion-button>
          <ion-button class="action-btn" color="success" (click)="exportExcel()">
            <ion-icon name="download" slot="start"></ion-icon>
            Exportar Excel
          </ion-button>
        </div>
      </div>
    </div>

    <div class="report-grid report-grid--two" *ngIf="summary">
      <div class="report-card highlight">
        <div class="section-header">
          <h3>Resumo do período</h3>
          <p>
            Indicadores do período selecionado •
            {{ selectedDate | date: periodType === 'mes' ? 'MM/yyyy' : 'dd/MM/yyyy' }}
          </p>
        </div>
        <div class="form-row">
          <div class="value-box">
            <span class="value-label">Entradas</span>
            <span class="value-value success">{{ formattingService.formatCurrency(summary.totalEntradas) }}</span>
          </div>
          <div class="value-box">
            <span class="value-label">Saídas</span>
            <span class="value-value danger">{{ formattingService.formatCurrency(summary.totalSaidas) }}</span>
          </div>
        </div>
        <div class="value-box full">
          <span class="value-label">Saldo</span>
          <span class="value-value" [class.success]="summary.saldo >= 0" [class.danger]="summary.saldo < 0">
            {{ formattingService.formatCurrency(summary.saldo) }}
          </span>
        </div>
        <div class="value-box full">
          <span class="value-label">Saldo total em caixa</span>
          <span class="value-value" [class.success]="totalCashBalance >= 0" [class.danger]="totalCashBalance < 0">
            {{ formattingService.formatCurrency(totalCashBalance) }}
          </span>
        </div>
        <div class="empty-state" *ngIf="totalTransacoes === 0">
          <p>Nenhuma movimentação encontrada no período.</p>
        </div>
      </div>
  
      <div class="report-card">
        <div class="section-header">
          <h3>Entradas x Saídas</h3>
          <p>Comparativo rápido do período selecionado</p>
        </div>
        <div class="comparison-chart">
          <div class="chart-row">
            <div class="chart-label">Entradas</div>
            <div class="chart-bar-container">
              <div
                class="chart-bar-fill success"
                [style.width.%]="getComparisonPercentage(summary.totalEntradas)"
              ></div>
              <span class="chart-value-inline">{{ formattingService.formatCurrency(summary.totalEntradas) }}</span>
            </div>
          </div>
          <div class="chart-row">
            <div class="chart-label">Saídas</div>
            <div class="chart-bar-container">
              <div
                class="chart-bar-fill danger"
                [style.width.%]="getComparisonPercentage(summary.totalSaidas)"
              ></div>
              <span class="chart-value-inline">{{ formattingService.formatCurrency(summary.totalSaidas) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="report-grid report-grid--two">
      <div class="report-card">
        <div class="section-header">
          <h3>Por Categoria</h3>
          <p>Distribuição das movimentações</p>
        </div>
        <div *ngIf="categoryEntries.length > 0; else noCategoryData">
          <div *ngFor="let item of categoryEntries" class="chart-item">
            <div class="chart-label">{{ item.category }}</div>
            <div class="chart-bar">
              <div class="chart-fill" [style.width.%]="getPercentage(item.amount)"></div>
            </div>
            <div class="chart-value">{{ formattingService.formatCurrency(item.amount) }}</div>
          </div>
        </div>
        <ng-template #noCategoryData>
          <div class="empty-state compact">
            <p>Nenhum dado disponível</p>
          </div>
        </ng-template>
      </div>
    
      <div class="report-card">
        <div class="section-header">
          <h3>Por Forma de Pagamento</h3>
          <p>Concentração por meio de recebimento</p>
        </div>
        <div *ngIf="paymentMethodEntries.length > 0; else noPaymentData">
          <div *ngFor="let item of paymentMethodEntries" class="chart-item">
            <div class="chart-label">{{ item.method }}</div>
            <div class="chart-bar">
              <div class="chart-fill" [style.width.%]="getPercentage(item.amount)"></div>
            </div>
            <div class="chart-value">{{ formattingService.formatCurrency(item.amount) }}</div>
          </div>
        </div>
        <ng-template #noPaymentData>
          <div class="empty-state compact">
            <p>Nenhum dado disponível</p>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="report-card">
      <div class="section-header">
        <h3>Estatísticas</h3>
        <p>Indicadores rápidos para análise</p>
      </div>
      <div class="summary-list" *ngIf="summary; else noStats">
        <div class="summary-row">
          <ion-icon name="bar-chart"></ion-icon>
          <span>Total de transações</span>
          <strong>{{ totalTransacoes }}</strong>
        </div>
        <div class="summary-row">
          <ion-icon name="pie-chart"></ion-icon>
          <span>Média de entradas</span>
          <strong>{{ formattingService.formatCurrency(summary ? getAverage(summary.totalEntradas, 'entrada') : 0) }}</strong>
        </div>
        <div class="summary-row">
          <ion-icon name="pie-chart"></ion-icon>
          <span>Média de saídas</span>
          <strong>{{ formattingService.formatCurrency(summary ? getAverage(summary.totalSaidas, 'saida') : 0) }}</strong>
        </div>
      </div>
      <ng-template #noStats>
        <div class="empty-state compact">
          <p>Selecione um período para visualizar estatísticas.</p>
        </div>
      </ng-template>
    </div>
  </div>
</ion-content>
